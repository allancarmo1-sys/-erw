local Players = game:GetService("Players")
local DataStoreService = game:GetService("DataStoreService")
local MarketplaceService = game:GetService("MarketplaceService")

local CharacterStats = {}
local PlayerDataStore = DataStoreService:GetDataStore("PlayerData_v1")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local sessionStats = {}
local WEAPON_SOURCE = ReplicatedStorage:WaitForChild("Items"):WaitForChild("Weapons")

local ADDITIVE_STATS = {
	["PierceCount"] = true,
	["Bounces"] = true,
	["Amount"] = true,
	["ExtraJumps"] = true,
	["Duration"] = true,
	["Knockback"] = true,
}

-- === DEFAULT DATA (New Profile) ===
local DEFAULT_STATS = {
	MaxHP = 100, --F
	HPRegen = 10, --F
	Lifesteal = 0, --M
	Overheal = 0, --F
	Shield = 0, --F
	Armor = 0, --M
	Thorns = 0, --F
	Evasion = 0, --M

	Damage = 1, --M
	CritChance = 0, --M
	CritDamage = 0, --M
	Cooldown = 1, --M
	Amount = 0, --F
	Bounces = 0, --F

	Range = 1, --M
	AttackSpeed = 1, --M
	Duration = 1, --F
	DamageToElites = 1, --M
	Knockback = 0, --F
	Speed = 5, --M

	ExtraJumps = 0, --F
	JumpPower = 1, --M
	Luck = 1, --M
	Difficulty = 1, --F

	Magnet = 1, --M
	EXPGain = 1, --F
	GoldGain = 1, --F

	-- pet stats
	PetAmount = 1,
	PetDamage = 1,
	PetCooldown = 1,

	-- for testing, leave at 1. On release, at 0
	Rerolls = 1,
	Skips = 1,
	Banishes = 1,
	ExtraLives = 0,

	-- invisible stats
	Gold = 0,
	RevivedThisGame = false,

	IncomingDamageMulti = 1, --M
	MaxWeapons = 2,
	MaxCharms = 2,

	UnlockedItems = {
		Weapons = {"Bouncy", "Sniper", "Boomerang"},
		Charms = {"Spinach", "Clover"}
	},

	-- format: { ["Sniper"] = 1, ["Spinach"] = 2 }
	Inventory = {
		Weapons = {},
		Charms = {}
	},
	
	BanishedItems = {}

}

-- === HELPER: DEEP COPY ===
local function deepCopy(original)
	local copy = {}
	for k, v in pairs(original) do
		copy[k] = type(v) == "table" and deepCopy(v) or v
	end
	return copy
end

function CharacterStats.BanishItem(player, itemId)
	local data = sessionStats[player]
	if data then
		data.BanishedItems[itemId] = true
		print("Banished item:", itemId)
	end
end

function CharacterStats.IsBanished(player, itemId)
	local data = sessionStats[player]
	if data and data.BanishedItems then
		return data.BanishedItems[itemId] == true
	end
	return false
end

function CharacterStats.IsOwned(player, itemId)
	local data = sessionStats[player]
	if not data then return false end

	local hasWeapon = data.Inventory.Weapons[itemId] ~= nil
	local hasCharm = data.Inventory.Charms[itemId] ~= nil

	return hasWeapon or hasCharm
end

function CharacterStats.InitPlayer(player)
	local key = "Player_" .. player.UserId
	local success, savedData = pcall(function() return PlayerDataStore:GetAsync(key) end)

	if success and savedData then
		sessionStats[player] = deepCopy(DEFAULT_STATS)
		if savedData.Gold then sessionStats[player].Gold = savedData.Gold end
		if savedData.Inventory then sessionStats[player].Inventory = savedData.Inventory end
		if savedData.ExtraLives then sessionStats[player].ExtraLives = savedData.ExtraLives end
		print("Loaded data for " .. player.Name)
	else
		sessionStats[player] = deepCopy(DEFAULT_STATS)
		CharacterStats.AddItem(player, "Bouncy", "Weapon") 
		print("New profile for " .. player.Name)
	end

	-- Reset Session Flag on Join
	sessionStats[player].RevivedThisGame = false

	player.CharacterAdded:Connect(function(char)
		task.wait(0.2) 
		CharacterStats:RefreshCharacter(player)
		CharacterStats.EquipWeapons(player)
	end)
end

function CharacterStats.SavePlayer(player)
	local data = sessionStats[player]
	if not data then return end
	local key = "Player_" .. player.UserId
	local saveTable = { 
		Gold = data.Gold, 
		Inventory = data.Inventory,
		ExtraLives = data.ExtraLives
	}
	pcall(function() PlayerDataStore:SetAsync(key, saveTable) end)
end

function CharacterStats.CanBeRevived(targetPlayer)
	local data = sessionStats[targetPlayer]
	if not data then return false end
	-- Can only be revived if they haven't been revived yet this session
	return not data.RevivedThisGame
end

function CharacterStats.MarkAsRevived(targetPlayer)
	local data = sessionStats[targetPlayer]
	if data then
		data.RevivedThisGame = true
	end
end

function CharacterStats.GetStats(player)
	return sessionStats[player] or deepCopy(DEFAULT_STATS)
end

function CharacterStats:GetStat(player, statName)
	local data = sessionStats[player]
	if data and data[statName] ~= nil then return data[statName] end
	return DEFAULT_STATS[statName]
end

function CharacterStats.SetStat(player, statName, value)
	local data = sessionStats[player]
	if data then
		data[statName] = value
		if statName == "MaxHP" or statName == "Speed" or statName == "JumpPower" then
			CharacterStats:RefreshCharacter(player)
		end
	end
end

local function SyncAttributes(weaponInstance, statTable)
	local weaponName = weaponInstance.Name
	local sourceTemplate = WEAPON_SOURCE:FindFirstChild(weaponName)
	if not sourceTemplate then return end

	for statName, invValue in pairs(statTable) do
		local baseAttr = sourceTemplate:GetAttribute(statName)
		if baseAttr then
			local finalValue = ADDITIVE_STATS[statName] and (baseAttr + invValue) or (baseAttr * invValue)
			weaponInstance:SetAttribute(statName, finalValue)
		end
	end
end

function CharacterStats.EquipWeapons(player)
	local data = sessionStats[player]
	if not data or not player.Character then return end

	for weaponName, weaponData in pairs(data.Inventory.Weapons) do
		if not player.Character:FindFirstChild(weaponName) then
			local source = WEAPON_SOURCE:FindFirstChild(weaponName)
			if source then
				local clone = source:Clone()
				clone.Name = weaponName
				SyncAttributes(clone, weaponData.Stats) 
				clone.Parent = player.Character
				clone.Enabled = true
			end
		end
	end
end

function CharacterStats.AddItem(player, itemId, itemType, upgradeData)
	local data = sessionStats[player]
	if not data then return end

	if itemType == "Weapon" then
		local inventoryEntry = data.Inventory.Weapons[itemId]
		if not inventoryEntry then
			local initialStats = {}
			if upgradeData then
				for stat, val in pairs(upgradeData) do initialStats[stat] = val end
			else
				initialStats = { Damage = 1, Cooldown = 1, Range = 1 }
			end

			data.Inventory.Weapons[itemId] = { Level = 1, Stats = initialStats }
			if player.Character then
				local source = WEAPON_SOURCE:FindFirstChild(itemId)
				if source then
					local clone = source:Clone()
					clone.Name = itemId
					SyncAttributes(clone, initialStats)
					clone.Parent = player.Character
					clone.Enabled = true
				end
			end
		else
			inventoryEntry.Level = inventoryEntry.Level + 1
			if upgradeData then
				for stat, amount in pairs(upgradeData) do
					local defaultTracker = ADDITIVE_STATS[stat] and 0 or 1
					local currentTracker = inventoryEntry.Stats[stat] or defaultTracker
					inventoryEntry.Stats[stat] = math.floor((currentTracker + amount) * 100) / 100
				end
			end
			if player.Character then
				local liveWeapon = player.Character:FindFirstChild(itemId)
				if liveWeapon then SyncAttributes(liveWeapon, inventoryEntry.Stats) end
			end
		end

	elseif itemType == "Charm" then
		local inventoryEntry = data.Inventory.Charms[itemId]

		-- upgradeData is now always { StatName = Value }
		if not inventoryEntry then
			local initialStat = {}
			if upgradeData then
				for stat, amount in pairs(upgradeData) do
					local current = CharacterStats:GetStat(player, stat)
					CharacterStats.SetStat(player, stat, current + amount)
					initialStat[stat] = amount
				end
			end

			data.Inventory.Charms[itemId] = {
				Level = 1,
				Stats = initialStat 
			}
			print("Unlocked New Charm: " .. itemId)

		else
			inventoryEntry.Level = inventoryEntry.Level + 1

			if upgradeData then
				for stat, amount in pairs(upgradeData) do
					local current = CharacterStats:GetStat(player, stat)
					CharacterStats.SetStat(player, stat, current + amount)

					local savedVal = inventoryEntry.Stats[stat] or 0
					inventoryEntry.Stats[stat] = savedVal + amount
				end
			end
			print("Upgraded " .. itemId .. " to Lvl " .. inventoryEntry.Level)
		end
	end
end

function CharacterStats.GetItemLevel(player, itemId)
	local data = sessionStats[player]
	if not data then return 0 end
	local wep = data.Inventory.Weapons[itemId]
	local charm = data.Inventory.Charms[itemId]
	return wep or charm or 0
end

function CharacterStats:RefreshCharacter(player)
	local char = player.Character
	local hum = char and char:FindFirstChild("Humanoid")
	local data = sessionStats[player]

	if hum and data then
		hum.MaxHealth = data.MaxHP
		hum.JumpPower = data.JumpPower * 50
		hum.WalkSpeed = data.Speed * 16
	end
end

Players.PlayerRemoving:Connect(function(player)
	CharacterStats.SavePlayer(player)
	sessionStats[player] = nil
end)

return CharacterStats
