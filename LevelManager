local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local ServerScriptService = game:GetService("ServerScriptService")

-- Dependencies
local GameSession = require(ServerScriptService:WaitForChild("GameSession"))
local PauseEvent = game:GetService("ReplicatedStorage"):WaitForChild("PauseEvent")

local LevelManager = {}

-- === CONFIGURATION ===
local BASE_EXP_REQ = 100
local GROWTH_FACTOR = 1.2
local PLAYER_SCALING = 0.5
local SELECTION_TIMEOUT = 15

-- === STATE ===
local GlobalLevel = 1
local GlobalExp = 0
local CurrentThreshold = BASE_EXP_REQ
local IsLevelingUp = false
local PendingSelections = {}

-- === REMOTES ===
local Events = ReplicatedStorage:FindFirstChild("GameEvents") 
if not Events then
	Events = Instance.new("Folder")
	Events.Name = "GameEvents"
	Events.Parent = ReplicatedStorage
end

local ExpUpdateEvent = Events:FindFirstChild("ExpUpdate") or Instance.new("RemoteEvent", Events)
ExpUpdateEvent.Name = "ExpUpdate"

local LevelUpEvent = Events:FindFirstChild("LevelUp") or Instance.new("RemoteEvent", Events)
LevelUpEvent.Name = "LevelUp"

local RewardSelectedEvent = Events:FindFirstChild("RewardSelected") or Instance.new("RemoteEvent", Events)
RewardSelectedEvent.Name = "RewardSelected"

-- === HELPER FUNCTIONS ===

local function CalculateThreshold()
	local playerCount = math.max(1, #Players:GetPlayers())
	local playerMultiplier = 1 + ((playerCount - 1) * PLAYER_SCALING)
	local req = (BASE_EXP_REQ * (GROWTH_FACTOR ^ (GlobalLevel - 1))) * playerMultiplier
	return math.floor(req)
end

local function FireExpUpdate()
	ExpUpdateEvent:FireAllClients(GlobalExp, CurrentThreshold, GlobalLevel)
end

-- This function decides whether to Unpause or Level Up AGAIN
local function ProcessNextStep()
	-- 1. Check if we have enough EXP for ANOTHER level
	if GlobalExp >= CurrentThreshold then
		print("Multiple levels detected! Triggering next level immediately...")
		task.wait(.5)
		LevelManager.TriggerLevelUp()
	else
		-- 2. No more levels pending? Resume the game.
		print("Leveling complete. Resuming game.")
		IsLevelingUp = false
		PendingSelections = {}
		GameSession.SetPause(false)
	end
end

-- === PUBLIC API ===

function LevelManager.Init()
	GlobalLevel = 1
	GlobalExp = 0
	CurrentThreshold = CalculateThreshold()
	IsLevelingUp = false
	PendingSelections = {}
	FireExpUpdate()

	if not RewardSelectedEvent.OnServerEvent:Connect(function() end).Connected then
		RewardSelectedEvent.OnServerEvent:Connect(function(player)
			if PendingSelections[player] then
				PendingSelections[player] = nil
				print(player.Name .. " selected a reward.")

				-- Check if EVERYONE has chosen
				if next(PendingSelections) == nil then
					-- Everyone is done. Check if we need to level up again or resume.
					ProcessNextStep()
				end
			end
		end)
	end
end

function LevelManager.AddExp(amount)
	-- FIX: ALWAYS add EXP, never return early.
	GlobalExp = GlobalExp + amount

	-- Only trigger the sequence if we aren't ALREADY doing it.
	-- If IsLevelingUp is true, we just accumulate the EXP silently.
	-- ProcessNextStep() will handle this overflow after the current selection is done.
	if not IsLevelingUp and GlobalExp >= CurrentThreshold then
		LevelManager.TriggerLevelUp()
	else
		FireExpUpdate()
	end
end

function LevelManager.TriggerLevelUp()
	IsLevelingUp = true

	-- 1. Consume the EXP for THIS level only
	GlobalExp = GlobalExp - CurrentThreshold

	-- 2. Scale Up
	GlobalLevel = GlobalLevel + 1
	CurrentThreshold = CalculateThreshold()

	print("LEVEL UP! New Level: " .. GlobalLevel .. " | New Req: " .. CurrentThreshold .. " | Floating Exp: " .. GlobalExp)

	-- 3. Pause Game
	PauseEvent:Fire(true)

	-- 4. Setup Players
	PendingSelections = {}
	for _, p in pairs(Players:GetPlayers()) do
		PendingSelections[p] = true
	end

	-- 5. Fire Events
	LevelUpEvent:FireAllClients(GlobalLevel)
	FireExpUpdate() -- Update visual bar (it will likely drop to low % or jump up if huge overflow)

	-- 6. Timeout Failsafe
	-- If players take too long, force the next step
	local currentLevelSnapshot = GlobalLevel
	task.delay(SELECTION_TIMEOUT, function()
		if IsLevelingUp and GlobalLevel == currentLevelSnapshot then
			print("Selection timeout. Auto-selecting.")
			-- Force clear pending selections
			PendingSelections = {} 
			ProcessNextStep()
		end
	end)
end

function LevelManager.GetCurrentLevel()
	return GlobalLevel
end

return LevelManager
