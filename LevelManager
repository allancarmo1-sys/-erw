local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local ServerScriptService = game:GetService("ServerScriptService")
local Services = ReplicatedStorage:WaitForChild("MyServices"):WaitForChild("Services")

-- Dependencies
local GameSession = require(ServerScriptService:WaitForChild("GameSession"))
local PauseEvent = ReplicatedStorage:WaitForChild("PauseEvent")
local RewardHandler = require(ServerScriptService.RewardHandler)
local CharacterStats = require(Services:WaitForChild("CharacterStats"))

local LevelManager = {}
local OfferedOptions = {}

-- === CONFIGURATION ===
local BASE_EXP_REQ = 100
local GROWTH_FACTOR = 1.2
local PLAYER_SCALING = 0.5
local SELECTION_TIMEOUT = 15

-- === STATE ===
local GlobalLevel = 1
local GlobalExp = 0
local CurrentThreshold = BASE_EXP_REQ
local IsLevelingUp = false
local PendingSelections = {}

-- === REMOTES ===
local Events = ReplicatedStorage:FindFirstChild("GameEvents") 
if not Events then
	Events = Instance.new("Folder")
	Events.Name = "GameEvents"
	Events.Parent = ReplicatedStorage
end

local ExpUpdateEvent = Events:FindFirstChild("ExpUpdate") or Instance.new("RemoteEvent", Events)
ExpUpdateEvent.Name = "ExpUpdate"

local LevelUpEvent = Events:FindFirstChild("LevelUp") or Instance.new("RemoteEvent", Events)
LevelUpEvent.Name = "LevelUp"

local RewardSelectedEvent = Events:FindFirstChild("RewardSelected") or Instance.new("RemoteEvent", Events)
RewardSelectedEvent.Name = "RewardSelected"

-- === HELPER FUNCTIONS ===

local function CalculateThreshold()
	local playerCount = math.max(1, #Players:GetPlayers())
	local playerMultiplier = 1 + ((playerCount - 1) * PLAYER_SCALING)
	local req = (BASE_EXP_REQ * (GROWTH_FACTOR ^ (GlobalLevel - 1))) * playerMultiplier
	return math.floor(req)
end

local function FireExpUpdate()
	ExpUpdateEvent:FireAllClients(GlobalExp, CurrentThreshold, GlobalLevel)
end

-- This function decides whether to Unpause or Level Up AGAIN
local function ProcessNextStep()
	-- 1. Check if we have enough EXP for ANOTHER level
	if GlobalExp >= CurrentThreshold then
		print("Multiple levels detected! Triggering next level immediately...")
		task.wait(0.5) -- Slight buffer for UX
		LevelManager.TriggerLevelUp()
	else
		-- 2. No more levels pending? Resume the game.
		print("Leveling complete. Resuming game.")
		IsLevelingUp = false
		PendingSelections = {}

		-- Unpause Logic
		if GameSession.SetPause then
			GameSession.SetPause(false)
		else
			-- Fallback if GameSession function is missing/renamed
			PauseEvent:Fire(false)
			workspace:SetAttribute("GamePaused", false)
		end
	end
end

-- === PUBLIC API ===

function LevelManager.Init()
	GlobalLevel = 1
	GlobalExp = 0
	CurrentThreshold = CalculateThreshold()
	IsLevelingUp = false
	PendingSelections = {}
	FireExpUpdate()
	print("LevelManager Initialized.")
end

function LevelManager.AddExp(amount)
	GlobalExp = GlobalExp + amount

	-- Only trigger if not currently leveling up
	if not IsLevelingUp and GlobalExp >= CurrentThreshold then
		LevelManager.TriggerLevelUp()
	else
		FireExpUpdate()
	end
end

function LevelManager.TriggerLevelUp()
	if IsLevelingUp then return end -- Prevent double triggers
	IsLevelingUp = true
	
	GlobalExp = GlobalExp - CurrentThreshold

	GlobalLevel = GlobalLevel + 1
	CurrentThreshold = CalculateThreshold()

	print("LEVEL UP! New Level: " .. GlobalLevel .. " | Req: " .. CurrentThreshold)

	if GameSession.SetPause then
		GameSession.SetPause(true)
	else
		PauseEvent:Fire(true)
		workspace:SetAttribute("GamePaused", true)
	end

	PendingSelections = {}
	for _, p in pairs(Players:GetPlayers()) do
		PendingSelections[p] = true
		local options = RewardHandler.RollOptions(p, 3)
		OfferedOptions[p] = options 
		LevelUpEvent:FireClient(p, GlobalLevel, options)
	end

	FireExpUpdate()

	-- Timeout Failsafe
	local currentLevelSnapshot = GlobalLevel
	task.delay(SELECTION_TIMEOUT, function()
		if IsLevelingUp and GlobalLevel == currentLevelSnapshot then
			print("Selection timeout. Auto-resuming.")
			PendingSelections = {} 
			ProcessNextStep()
		end
	end)
end

function LevelManager.GetCurrentLevel()
	return GlobalLevel
end

RewardSelectedEvent.OnServerEvent:Connect(function(player, choiceIndex)
	if IsLevelingUp and PendingSelections[player] then
		local validOptions = OfferedOptions[player]

		if validOptions and validOptions[choiceIndex] then
			local choice = validOptions[choiceIndex]

			-- Pass the PAYLOAD to AddItem
			CharacterStats.AddItem(player, choice.Id, choice.Type, choice.Payload)

			-- Cleanup
			PendingSelections[player] = nil
			OfferedOptions[player] = nil

			if next(PendingSelections) == nil then
				ProcessNextStep()
			end
		end
	end
end)

return LevelManager
