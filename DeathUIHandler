local ReplicatedStorage = game:GetService("ReplicatedStorage")
local MarketplaceService = game:GetService("MarketplaceService")
local Players = game:GetService("Players")

local Events = ReplicatedStorage:WaitForChild("GameEvents")
local PlayerDiedEvent = Events:WaitForChild("PlayerDied")
local UpdateReviveListEvent = Events:WaitForChild("UpdateReviveList")
local RequestReviveEvent = Events:WaitForChild("RequestRevive")
local GetExtraLivesFunc = Events:WaitForChild("GetExtraLives")

local player = Players.LocalPlayer

local HUD = script.Parent:WaitForChild("HUD")

--selfrevive
local DeathFrame = script.Parent:WaitForChild("DeathScreen") -- MAKE THIS FRAME
DeathFrame.Visible = false

local ReviveButton = DeathFrame:WaitForChild("ReviveFrame"):WaitForChild("ReviveButton")
local BuyGoldBtn = DeathFrame:WaitForChild("ReviveGoldFrame"):WaitForChild("ReviveButton")

--friendrevive
local DeadPlayersContainer = HUD:WaitForChild("DeadPlayers")
local TemplateFrame = ReplicatedStorage:WaitForChild("GUIElements"):WaitForChild("DeadPlayersItems"):WaitForChild("ListObjectFrame")
TemplateFrame.Visible = false 

local ConfirmFrame = script.Parent:WaitForChild("ConfirmReviveFrame")
local ConfirmMath1 = ConfirmFrame:WaitForChild("TopFrame"):WaitForChild("BeforeLabel")
local ConfirmMath2 = ConfirmFrame:WaitForChild("TopFrame"):WaitForChild("AfterLabel")
local ConfirmBtn = ConfirmFrame:WaitForChild("YesFrame"):WaitForChild("YesButton")
local CancelBtn = ConfirmFrame:WaitForChild("NoFrame"):WaitForChild("NoButton")

local ROBUX_PRODUCT_ID = 3519622042

local activeReviveButtons = {} 
local targetReviveUser = nil 

--[[local function SetupSkinViewport(viewport, skinName)
	viewport:ClearAllChildren()

	-- 1. Find Skin Model
	-- Assuming you have a folder: ReplicatedStorage.Assets.Skins
	local skinsFolder = ReplicatedStorage:FindFirstChild("Assets") and ReplicatedStorage.Assets:FindFirstChild("Skins")
	local skinModel = skinsFolder and skinsFolder:FindFirstChild(skinName)

	-- Fallback if skin not found
	if not skinModel then 
		skinModel = skinsFolder and skinsFolder:FindFirstChild("Default")
	end

	if skinModel then
		local clone = skinModel:Clone()
		clone.Parent = viewport

		-- Setup Camera
		local cam = Instance.new("Camera")
		cam.Parent = viewport
		viewport.CurrentCamera = cam

		-- Position Camera to face the model's Head/PrimaryPart
		local primary = clone.PrimaryPart or clone:FindFirstChild("Head") or clone:FindFirstChild("HumanoidRootPart")
		if primary then
			-- Adjust these offsets based on your model size
			local forward = primary.CFrame.LookVector
			local pos = primary.Position + (forward * 5) + Vector3.new(0, 0.5, 0)
			cam.CFrame = CFrame.new(pos, primary.Position)
		end
	end
end]]

PlayerDiedEvent.OnClientEvent:Connect(function(canRevive, livesCount, goldCount, goldCost)
	DeathFrame.Visible = true

	if not canRevive then
		UseLifeBtn.Visible = false
		BuyGoldBtn.Visible = false
		return
	end

	UseLifeBtn.Text = "Use Extra Life (" .. livesCount .. ")"
	UseLifeBtn.Interactable = (livesCount > 0)

	BuyGoldBtn.Text = "Revive with Gold (" .. goldCost .. ")"
	BuyGoldBtn.Interactable = (goldCount >= goldCost)

	BuyRobuxBtn.Text = "Buy Life (50 R$)"
end)

BuyGoldBtn.MouseButton1Click:Connect(function()
	DeathFrame.Visible = false
	RequestReviveEvent:FireServer("BuyGold")
end)

ReviveButton.MouseButton1Click:Connect(function()
	MarketplaceService:PromptProductPurchase(Players.LocalPlayer, ROBUX_PRODUCT_ID)
end)

local function CreateReviveButton(userId, data)
	if activeReviveButtons[userId] then activeReviveButtons[userId]:Destroy() end

	local frame = TemplateFrame:Clone()
	frame.Name = "Revive_" .. userId
	frame.Visible = true

	local nameLabel = frame.PlayerFrame.PlayerName
	if nameLabel then nameLabel.Text = data.Name end

	--[[local avatarContainer = frame:FindFirstChild("AvatarContainer") or frame:FindFirstChild("Avatar")

	if avatarContainer then
		if avatarContainer:IsA("ViewportFrame") then
			SetupSkinViewport(avatarContainer, data.Skin)
		elseif avatarContainer:IsA("ImageLabel") then
			-- If you use 2D images for skins, map skinName to ImageId here
			-- avatarContainer.Image = "rbxassetid://..."
		end
	end]]

	-- 4. Setup Button Logic
	-- Assuming the whole frame is a button, or there is a specific button inside
	local btn = frame.ReviveFrame.ImageButton 

	if btn then
		btn.MouseButton1Click:Connect(function()
			local myLives = GetExtraLivesFunc:InvokeServer()

			targetReviveUser = Players:GetPlayerByUserId(userId)
			if not targetReviveUser then return end

			if myLives > 0 then
				ConfirmFrame.Visible = true
				ConfirmMath1.Text = myLives
				ConfirmMath2.Text = myLives - 1
			else
				MarketplaceService:PromptProductPurchase(player, ROBUX_PRODUCT_ID)
			end
		end)
	end

	frame.Parent = DeadPlayersContainer
	activeReviveButtons[userId] = frame
end

UpdateReviveListEvent.OnClientEvent:Connect(function(deadPlayersMap)
	for uid, frame in pairs(activeReviveButtons) do
		if not deadPlayersMap[uid] then
			frame:Destroy()
			activeReviveButtons[uid] = nil
			if targetReviveUser and targetReviveUser.UserId == uid then
				ConfirmFrame.Visible = false
				targetReviveUser = nil
			end
		end
	end

	for uidStr, data in pairs(deadPlayersMap) do
		local uid = tonumber(uidStr)
		if uid ~= player.UserId and not activeReviveButtons[uid] then
			CreateReviveButton(uid, data)
		end
	end
end)

ConfirmBtn.MouseButton1Click:Connect(function()
	if targetReviveUser then
		RequestReviveEvent:FireServer(targetReviveUser, "UseLife")
		ConfirmFrame.Visible = false
		targetReviveUser = nil
	end
end)

CancelBtn.MouseButton1Click:Connect(function()
	ConfirmFrame.Visible = false
	targetReviveUser = nil
end)
