local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService") -- Needed for timer loop
local Events = ReplicatedStorage:WaitForChild("GameEvents")
local EasyVisuals = require(ReplicatedStorage:WaitForChild("Animations"):WaitForChild("EasyVisuals"))

local LevelUpFrame = script.Parent:WaitForChild("LevelUpBar")
local expBar = LevelUpFrame:WaitForChild("Bar")

local rewardFrame = script.Parent:WaitForChild("ChooseReward")
-- Ensure you created this TextLabel in your GUI!
local timerLabel = rewardFrame:WaitForChild("RewardTimer"):WaitForChild("Timer")

local option1Button = rewardFrame:WaitForChild("Option1Frame"):WaitForChild("OptionButton")
local option2Button = rewardFrame:WaitForChild("Option2Frame"):WaitForChild("OptionButton")
local option3Button = rewardFrame:WaitForChild("Option3Frame"):WaitForChild("OptionButton")

local currentEffects = {}
local activeTimerConnection = nil -- Store connection to cancel it properly

local RewardSelectedEvent = Events:FindFirstChild("RewardSelected") or Instance.new("RemoteEvent", Events)
RewardSelectedEvent.Name = "RewardSelected"

local function ClearEffects()
	for _, eff in pairs(currentEffects) do
		if eff then eff:Destroy() end
	end
	currentEffects = {}
end

local function CleanupTimer()
	if activeTimerConnection then
		activeTimerConnection:Disconnect()
		activeTimerConnection = nil
	end
	timerLabel.Text = ""
end

local function updateRewardOption(optButton, option)
	if option.IsNew then
		optButton.RarityLabel.Text = "New!"
		optButton.RarityLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
	else
		optButton.RarityLabel.Text = option.Rarity
		optButton.RarityLabel.TextColor3 = option.RarityColor
	end
	optButton.BackgroundColor3 = option.RarityColor
	optButton.Description.ItemName.Text = option.Name
	optButton.Description.ItemStats.Text = option.Description
end

Events.ExpUpdate.OnClientEvent:Connect(function(current, max, level)
	local percent = math.clamp(current / max, 0, 1)
	expBar.Size = UDim2.new(percent, 0, 1, 0)
end)

-- Receive Duration from Server
Events.LevelUp.OnClientEvent:Connect(function(newLevel, rewardOptions, duration)
	CleanupTimer() -- Stop any previous timer
	ClearEffects()

	rewardFrame.Visible = true
	local eff = EasyVisuals.new(rewardFrame.TopTextFrame.TextLabel, "Rainbow", .5)
	table.insert(currentEffects, eff)
	-- Populate UI
	for i, opt in ipairs(rewardOptions) do
		local targetBtn
		if i == 1 then targetBtn = option1Button
		elseif i == 2 then targetBtn = option2Button
		elseif i == 3 then targetBtn = option3Button
		end

		if targetBtn then
			updateRewardOption(targetBtn, opt)
			local eff = EasyVisuals.new(targetBtn, "WaveStroke", .5, 6, false, opt.RarityColor)
			table.insert(currentEffects, eff)
		end
	end

	-- START COUNTDOWN
	local endTime = tick() + (duration or 15)

	activeTimerConnection = RunService.Heartbeat:Connect(function()
		local remaining = math.max(0, endTime - tick())

		-- Format: "14.5s"
		timerLabel.Text = string.format("%.1fs", remaining)

		if remaining <= 0 then
			-- TIME IS UP!
			CleanupTimer()
			-- Auto-Select Option 1 to match server failsafe AND close UI
			SelectReward(1)
		end
	end)
end)

function SelectReward(rewardId)
	CleanupTimer() -- Stop timer immediately
	ClearEffects()

	rewardFrame.Visible = false
	RewardSelectedEvent:FireServer(rewardId)
end

option1Button.MouseButton1Click:Connect(function() SelectReward(1) end)
option2Button.MouseButton1Click:Connect(function() SelectReward(2) end)
option3Button.MouseButton1Click:Connect(function() SelectReward(3) end)
