local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players") -- Needed to check for players
local Debris = game:GetService("Debris")

local VisualEvent = ReplicatedStorage:WaitForChild("VisualProjectileEvent")

local function GetDebrisFolder()
	local folder = workspace:FindFirstChild("Debris")
	if not folder then
		folder = Instance.new("Folder")
		folder.Name = "Debris"
		folder.Parent = workspace
	end
	return folder
end

local function CreatePart(color, startPos)
	local debrisFolder = GetDebrisFolder()

	local part = Instance.new("Part")
	part.Size = Vector3.new(0.5, 0.5, 2)
	part.Color = color
	part.Material = Enum.Material.Neon
	part.CanCollide = false
	part.Anchored = true
	part.CFrame = CFrame.new(startPos)
	part.Parent = debrisFolder

	return part
end

local function IsPlayerCharacter(part)
	if not part or not part.Parent then return false end
	return Players:GetPlayerFromCharacter(part.Parent) ~= nil
end

local function MoveDirectional(bullet, startPos, direction, speed, isBoomerang, isSniper, maxDist)
	local startTime = tick()
	local maxLifeTime = (maxDist or 300) / speed

	bullet.CFrame = CFrame.new(startPos, startPos + direction)

	local connection
	connection = RunService.RenderStepped:Connect(function(dt)
		if not bullet.Parent then connection:Disconnect() return end

		local step = direction * speed * dt
		local nextPos = bullet.Position + step

		-- check collision for Normal bullets
		if not isBoomerang and not isSniper then
			local rayParams = RaycastParams.new()
			rayParams.FilterType = Enum.RaycastFilterType.Exclude
			rayParams.FilterDescendantsInstances = {Players.LocalPlayer.Character, workspace.Debris}

			local hitResult = workspace:Raycast(bullet.Position, step, rayParams)

			if hitResult then
				local hitHum = hitResult.Instance.Parent:FindFirstChild("Humanoid")
				if hitHum or hitResult.Instance.CanCollide then
					bullet:Destroy()
					connection:Disconnect()
					return
				end
			end
		end

		bullet.Position = nextPos

		if tick() - startTime >= maxLifeTime then
			bullet:Destroy()
			connection:Disconnect()
		end
	end)
end

local function MoveHoming(bullet, targetPart, speed)
	local connection
	connection = RunService.RenderStepped:Connect(function(dt)
		-- Safety Cleanup
		if not bullet.Parent or not targetPart or not targetPart.Parent then 
			if bullet.Parent then bullet:Destroy() end
			connection:Disconnect() 
			return 
		end

		local currentPos = bullet.Position
		local targetPos = targetPart.Position or targetPart:FindFirstChild("HumanoidRootPart").Position

		-- follow the target
		local direction = (targetPos - currentPos).Unit
		local step = direction * speed * dt

		bullet.Position = currentPos + step
		bullet.CFrame = CFrame.new(bullet.Position, targetPos)

		-- destroy if it reaches the target
		if (targetPos - currentPos).Magnitude < 2 then
			bullet:Destroy()
			connection:Disconnect()
		end
	end)
end

VisualEvent.OnClientEvent:Connect(function(startPos, targetData, speed, color, isBoomerang, isSniper, maxDist)
	local bullet = CreatePart(color, startPos)

	if typeof(targetData) == "Instance" then

		local targetPart = targetData.Parent:FindFirstChild("HumanoidRootPart") or targetData.Parent:FindFirstChild("Torso") or targetData

		if isBoomerang then
			if IsPlayerCharacter(targetPart) then
				MoveHoming(bullet, targetPart, speed)
			else
				local direction = (targetPart.Position - startPos).Unit
				MoveDirectional(bullet, startPos, direction, speed, isBoomerang, isSniper, maxDist)
			end

		elseif isSniper then
			local direction = (targetPart.Position - startPos).Unit
			MoveDirectional(bullet, startPos, direction, speed, isBoomerang, isSniper, maxDist)

		else
			MoveHoming(bullet, targetPart, speed)
		end

	elseif typeof(targetData) == "Vector3" then
		local direction = (targetData - startPos).Unit
		MoveDirectional(bullet, startPos, direction, speed, isBoomerang, isSniper, maxDist)
	end
end)
