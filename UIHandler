local ReplicatedStorage = game:GetService("ReplicatedStorage")
local CollectionService = game:GetService("CollectionService")
local RunService = game:GetService("RunService") 
local Events = ReplicatedStorage:WaitForChild("GameEvents")
local EasyVisuals = require(ReplicatedStorage:WaitForChild("Animations"):WaitForChild("EasyVisuals"))

local HUD = script.Parent:WaitForChild("HUD")
local LevelUpFrame = HUD:WaitForChild("LevelUpBar")
local expBar = LevelUpFrame:WaitForChild("Bar")
local levelLabel = HUD:WaitForChild("LevelUpBar"):WaitForChild("LevelCounterFrame"):WaitForChild("LevelCounter")

local rewardFrame = script.Parent:WaitForChild("ChooseReward")
local timerLabel = rewardFrame:WaitForChild("RewardTimer"):WaitForChild("Timer")
local gameTimerLabel = HUD:WaitForChild("TimeLeft"):WaitForChild("TimeCounter")

-- Option Buttons
local option1Button = rewardFrame:WaitForChild("Option1Frame"):WaitForChild("OptionButton")
local option2Button = rewardFrame:WaitForChild("Option2Frame"):WaitForChild("OptionButton")
local option3Button = rewardFrame:WaitForChild("Option3Frame"):WaitForChild("OptionButton")

-- Power Buttons
local rerollButton = rewardFrame:WaitForChild("Reroll")
local banishButton = rewardFrame:WaitForChild("Banish")

-- Counters (Assumes TextLabels named 'CountLabel' inside the buttons)
local rerollCountLabel = rerollButton:WaitForChild("RerollCount")
local banishCountLabel = banishButton:WaitForChild("BanishCount")

local currentEffects = {}
local activeTimerConnection = nil

-- STATE
local isBanishMode = false

-- EVENTS
local RewardSelectedEvent = Events:FindFirstChild("RewardSelected") or Instance.new("RemoteEvent", Events)
RewardSelectedEvent.Name = "RewardSelected"
local RerollEvent = Events:WaitForChild("RerollOptions")
local BanishEvent = Events:WaitForChild("BanishOption")

local function ClearEffects()
	for _, eff in pairs(currentEffects) do
		if eff then eff:Destroy() end
	end
	currentEffects = {}
end

local function CleanupTimer()
	if activeTimerConnection then
		activeTimerConnection:Disconnect()
		activeTimerConnection = nil
	end
	timerLabel.Text = ""
end

local function UpdateLevelDisplay(level)
	if levelLabel then
		levelLabel.Text = level
	end
end

local function updateRewardOption(optButton, option)
	if option.IsNew then
		optButton.RarityLabel.Text = "New!"
		optButton.RarityLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
		optButton.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
	else
		optButton.RarityLabel.Text = option.Rarity
		optButton.RarityLabel.TextColor3 = option.RarityColor
		optButton.BackgroundColor3 = option.RarityColor
	end
	optButton.Description.ItemName.Text = option.Name
	optButton.Description.ItemStats.Text = option.Description
end

-- === MODE TOGGLING ===
local function SetBanishMode(active)
	isBanishMode = active

	if active then
		banishButton.BanishText.Text = "Cancel"
		banishButton.BackgroundColor3 = Color3.fromRGB(255, 100, 100) -- Red visual cue
		-- Optional: Dim the option buttons or show a 'Banish' icon over them
	else
		banishButton.BanishText.Text = "Banish"
		banishButton.BackgroundColor3 = Color3.fromRGB(255, 255, 255) -- Reset color
	end
end

-- === CLICK HANDLERS ===

local function OnOptionClicked(index)
	if isBanishMode then
		-- ACTION: BANISH
		-- Close the window immediately as we are skipping this reward cycle
		CleanupTimer() 
		ClearEffects()
		rewardFrame.Visible = false

		BanishEvent:FireServer(index)
		SetBanishMode(false) 
	else
		-- ACTION: SELECT
		CleanupTimer() 
		ClearEffects()
		rewardFrame.Visible = false
		RewardSelectedEvent:FireServer(index)
	end
end

rerollButton.MouseButton1Click:Connect(function()
	if isBanishMode then SetBanishMode(false) end -- Safety reset
	RerollEvent:FireServer()
end)

banishButton.MouseButton1Click:Connect(function()
	-- Toggle Mode
	SetBanishMode(not isBanishMode)
end)

option1Button.MouseButton1Click:Connect(function() OnOptionClicked(1) end)
option2Button.MouseButton1Click:Connect(function() OnOptionClicked(2) end)
option3Button.MouseButton1Click:Connect(function() OnOptionClicked(3) end)

-- === EVENTS ===

Events.ExpUpdate.OnClientEvent:Connect(function(current, max, level)
	local percent = math.clamp(current / max, 0, 1)
	expBar.Size = UDim2.new(percent, 0, 1, 0)
	
	UpdateLevelDisplay(level)
end)

Events.LevelUp.OnClientEvent:Connect(function(newLevel, rewardOptions, duration, rerollsLeft, banishesLeft)
	CleanupTimer() 
	ClearEffects()

	-- Reset State
	SetBanishMode(false)
	rewardFrame.Visible = true

	-- Update Counters
	rerollCountLabel.Text = "(" .. tostring(rerollsLeft or 0) .. " left)"
	banishCountLabel.Text = "(" .. tostring(banishesLeft or 0) .. " left)"

	-- Disable buttons if 0 (Optional Visuals)
	rerollButton.Interactable = (rerollsLeft > 0)
	banishButton.Interactable = (banishesLeft > 0)

	local eff = EasyVisuals.new(rewardFrame.TopTextFrame.TextLabel, "Rainbow", .5)
	table.insert(currentEffects, eff)

	for i, opt in ipairs(rewardOptions) do
		local targetBtn
		if i == 1 then targetBtn = option1Button
		elseif i == 2 then targetBtn = option2Button
		elseif i == 3 then targetBtn = option3Button
		end

		if targetBtn then
			updateRewardOption(targetBtn, opt)
			local eff = EasyVisuals.new(targetBtn, "WaveStroke", .5, 6, false, opt.RarityColor)
			table.insert(currentEffects, eff)
		end
	end

	local endTime = tick() + (duration or 15)
	activeTimerConnection = RunService.Heartbeat:Connect(function()
		local remaining = math.max(0, endTime - tick())
		timerLabel.Text = string.format("%.1f", remaining)
		if remaining <= 0 then
			CleanupTimer()
			-- Auto select (normal mode)
			RewardSelectedEvent:FireServer(1)
		end
	end)
end)

local function SetupGameTimer()
	local elapsedTime = 0
	local isBossActive = false
	local function CheckBossState()
		local bosses = CollectionService:GetTagged("Boss") 
		isBossActive = (#bosses > 0)
	end
	CollectionService:GetInstanceAddedSignal("Boss"):Connect(CheckBossState)
	CollectionService:GetInstanceRemovedSignal("Boss"):Connect(CheckBossState)
	RunService.Heartbeat:Connect(function(dt)
		local isGamePaused = workspace:GetAttribute("GamePaused") 
		if not isGamePaused and not isBossActive then
			elapsedTime = elapsedTime + dt
			local minutes = math.floor(elapsedTime / 60)
			local seconds = math.floor(elapsedTime % 60)
			gameTimerLabel.Text = string.format("%02d:%02d", minutes, seconds)
		end
	end)
end

SetupGameTimer()
